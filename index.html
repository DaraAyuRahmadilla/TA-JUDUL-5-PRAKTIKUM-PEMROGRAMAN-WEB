<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kalkulator Interaktif</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="calc-wrap">

    <div class="top-row">
      <div class="logo">KC</div>
      <div class="title">Kalkulator</div>
    </div>

    <!-- DISPLAY -->
    <div class="display">
      <div class="expr" id="expression">0</div>
      <div class="result" id="result">0</div>
    </div>

    <!-- BUTTONS -->
    <div class="kbd" id="buttons">
      <button class="btn" data-action="clear-entry">CE</button>
      <button class="btn" data-action="clear-all">C</button>
      <button class="btn" data-value="%">%</button>
      <button class="btn op" data-value="/">÷</button>

      <button class="btn" data-value="7">7</button>
      <button class="btn" data-value="8">8</button>
      <button class="btn" data-value="9">9</button>
      <button class="btn op" data-value="*">×</button>

      <button class="btn" data-value="4">4</button>
      <button class="btn" data-value="5">5</button>
      <button class="btn" data-value="6">6</button>
      <button class="btn op" data-value="-">−</button>

      <button class="btn" data-value="1">1</button>
      <button class="btn" data-value="2">2</button>
      <button class="btn" data-value="3">3</button>
      <button class="btn op" data-value="+">+</button>

      <button class="btn wide" data-value="0">0</button>
      <button class="btn" data-value=".">.</button>
      <button class="btn equal" data-action="equals">=</button>
    </div>

    <!-- SIDE PANELS -->
    <div class="side">

      <!-- HISTORY -->
      <div class="panel">
        <div class="panel-title">History</div>
        <div class="history-list" id="history"></div>
      </div>

      <!-- MEMORY -->
      <div class="panel">
        <div class="panel-title">Memory</div>
        <div class="memory-value" id="memValue">0</div>
        <div class="memory-buttons">
          <button class="mem-pill" data-action="mplus">M+</button>
          <button class="mem-pill" data-action="mminus">M-</button>
          <button class="mem-pill" data-action="mr">MR</button>
          <button class="mem-pill" data-action="mc">MC</button>
        </div>
      </div>

    </div>
  </div>

<script>
let currentEntry = '';
let tokens = [];
let memory = 0;
let history = [];
const HISTORY_MAX = 5;

const exprEl = document.getElementById('expression');
const resEl  = document.getElementById('result');
const historyEl = document.getElementById('history');

function render(){
  const displayExpr = (tokens.join(' ') + (currentEntry ? ' '+currentEntry : '')).trim();
  exprEl.innerText = displayExpr || '0';

  if (!resEl.classList.contains("error-text")) {
    resEl.innerText = evaluateSafeDisplay();
  }

  document.getElementById("memValue").innerText = memory;
}

function evaluateSafeDisplay(){
  try {
    const allTokens = tokens.concat(currentEntry ? [currentEntry] : []);
    if (allTokens.length === 0) return "0";

    const last = allTokens[allTokens.length - 1];

    if (!isNumberString(last)) {
      return currentEntry !== '' ? currentEntry : '0';
    }

    const rpn = toRPN(allTokens);
    const val = evalRPN(rpn);

    return formatNumber(val);
  } catch {
    return currentEntry !== '' ? currentEntry : '0';
  }
}

function toRPN(toks){
  const out = [], ops = [];
  const prec = {'+':1,'-':1,'*':2,'/':2,'%':2};

  for(let t of toks){
    if(isNumberString(t)) out.push(t);
    else {
      while(ops.length && prec[ops[ops.length-1]] >= prec[t]){
        out.push(ops.pop());
      }
      ops.push(t);
    }
  }
  while(ops.length) out.push(ops.pop());
  return out;
}

function evalRPN(rpn){
  const st = [];
  for(const t of rpn){
    if(isNumberString(t)) st.push(Number(t));
    else {
      const b = st.pop(), a = st.pop();
      if (t === '/' && b === 0) throw new Error("DivisionByZero");
      st.push(eval(`${a}${t}${b}`));
    }
  }
  return st[0];
}

function isNumberString(s){
  return /^-?\d+(\.\d+)?$/.test(s);
}

function formatNumber(n){
  return Number.isInteger(n) ? String(n) : String(Number(n.toFixed(10)));
}

document.addEventListener("click", e=>{
  const btn = e.target.closest("button");
  if(!btn) return;

  const val = btn.dataset.value;
  const action = btn.dataset.action;

  if(val !== undefined) handleValue(val);
  if(action) handleAction(action);

  render();
});

function handleValue(v){
  if(v === "."){
    if(!currentEntry.includes(".")) currentEntry = currentEntry ? currentEntry+"." : "0.";
    return;
  }
  if(["+","-","*","/","%"].includes(v)){
    if(currentEntry=== '' && tokens.length){
      const last = tokens[tokens.length-1];
      if(!isNumberString(last)) tokens[tokens.length-1]=v;
      return;
    }
    if(currentEntry === ''){
      if(v === '-') currentEntry = '-';
      return;
    }
    tokens.push(currentEntry, v);
    currentEntry='';
    return;
  }
  if(/^\d$/.test(v)){
    currentEntry = currentEntry==='0' ? v : currentEntry+v;
  }
}

function handleAction(a){
  resEl.classList.remove("error-text");

  if(a==="clear-entry"){ currentEntry=''; return; }
  if(a==="clear-all"){ currentEntry=''; tokens=[]; return; }

  if(a==="equals"){
    computeResult();
    return;
  }

  if(a==="mr"){ currentEntry=String(memory); return;}
  if(a==="mc"){ memory=0; return;}

  const val = parseFloat(evaluateSafeDisplay());
  if(!isNaN(val)){
    if(a==="mplus") memory+=val;
    if(a==="mminus") memory-=val;
  }
}

function computeResult(){
  try{
    if(currentEntry) tokens.push(currentEntry);
    if(tokens.length===0){ currentEntry='0'; return; }

    const rpn = toRPN(tokens);
    const val = evalRPN(rpn);

    addHistory(tokens.join(" "), formatNumber(val));

    currentEntry = String(formatNumber(val));
    tokens=[];
    resEl.classList.remove("error-text");

  } catch(e){
    resEl.innerText = e.message==="DivisionByZero" ? "Error: ÷ 0" : "Error";
    resEl.classList.add("error-text");
    tokens=[];
    currentEntry='';
  }
}

function addHistory(expr, result){
  history.unshift({expr,result});
  if(history.length>HISTORY_MAX) history.pop();
  renderHistory();
}

function renderHistory(){
  historyEl.innerHTML='';
  if(!history.length){
    historyEl.innerHTML='<div style="color:#94a3b8">Belum ada riwayat</div>';
    return;
  }
  history.forEach(h=>{
    const div = document.createElement("div");
    div.className="hist-item";
    div.innerHTML = `<div class="expr-short">${h.expr}</div>
                     <div class="res-badge">${h.result}</div>`;
    div.onclick = ()=>{ tokens=[]; currentEntry=h.result; render(); };
    historyEl.appendChild(div);
  });
}

window.addEventListener('keydown', e=>{
  if(/[0-9]/.test(e.key)) handleValue(e.key);
  else if(["+","-","*","/","%"].includes(e.key)) handleValue(e.key);
  else if(e.key==="Enter") handleAction("equals");
  else if(e.key==="Backspace"){
    if(currentEntry) currentEntry=currentEntry.slice(0,-1);
    else if(tokens.length){ const last=tokens.pop(); if(isNumberString(last)) currentEntry=last; }
  }
  else if(e.key.toLowerCase()==="c") handleAction("clear-all");
  else if(e.key.toLowerCase()==="e") handleAction("clear-entry");
  render();
});

render();
</script>

</body>
</html>